{% extends 'backend/school_administrator/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block custom_css %}

{% endblock custom_css %}

{% block breadcrumb %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Dashboard</h4>

            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">mVeri</a></li>
                    <li class="breadcrumb-item active">Profile</li>
                </ol>
            </div>

        </div>
    </div>
</div>
{% endblock breadcrumb %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center mb-3">
                <h3>High School Transcript</h3>
            </div>
            
            <div class="card-body">
                
                <div class="container mt-5">
                    <div class="text-center">
                        <h3>{{institution_name}}</h3>
                        <p>{{institution_address}}</p>
                        <p><strong>Phone:</strong> {{phone_number}}</p>
                    </div>
                
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Requested Date:</strong> {{ request_date }} </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p><strong>Graduation Year:</strong> {{ graduation_date }} </p>
                        </div>
                    </div>
                
                    <div class="row">
                        <div class="col-md-12">
                            <p><strong>Name:</strong>{{ student_name }} </p>
                        </div>
                    </div>
                
                    <h4 class="text-center">Official Transcript</h4>
                
                    <!-- Editable Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered" id="editableTable">
                            <thead class="table-dark">
                            <tr>
                                <th>Subjects</th>
                                <th>10th Grade</th>
                                <th>11th Grade</th>
                                <th>12th Grade</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                            </tr>
                            <!-- Additional rows go here -->
                            </tbody>
                            <tfoot>
                            <tr>
                                <td><strong>Average</strong></td>
                                <td contenteditable="true"></td>
                                <td contenteditable="true"></td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td><strong>Conduct</strong></td>
                                <td contenteditable="true">Good</td>
                                <td contenteditable="true">Good</td>
                                <td contenteditable="true">Good</td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                
                    <!-- Buttons to Add and Delete Row -->
                    <div class="text-end mt-3">
                        <button class="btn btn-primary" id="addRow"><i class="fas fa-plus"></i> Add Row</button>
                        <button class="btn btn-danger" id="deleteLastRow"><i class="fas fa-trash-alt"></i> Delete Last Row</button>
                        <button class="btn btn-success" id="submitForm"><i class="fas fa-save"></i> Save Transcript</button>
                    </div>
                
                    <div class="row mt-5">
                        <div class="col-md-6 text-start">
                            <p><strong>Signed:</strong> Registrar</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p><strong>Approved:</strong> Principal</p>
                        </div>
                    </div>
                
                    <p class="text-center text-muted">Any alteration on this document renders it invalid.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_script %}
<script>
    const student = "{{ student_name }}"; 
const institution = "{{ institution_name }}";
const graduation_year = "{{ graduation_date }}";
const requested_date = "{{ request_date }}";

// Function to add a new row
$('#addRow').click(function() {
    const newRow = `<tr>
                <td contenteditable="true" class="subject-cell"></td>
                <td contenteditable="true" class="grade-cell" data-grade="10"></td>
                <td contenteditable="true" class="grade-cell" data-grade="11"></td>
                <td contenteditable="true" class="grade-cell" data-grade="12"></td>
            </tr>`;
    $('#editableTable tbody').append(newRow);
});

// Function to delete the last row
$('#deleteLastRow').click(function() {
    $('#editableTable tbody tr:last').remove();
    calculateAverage();
});

// Function to calculate the average for each grade
function calculateAverage() {
    const gradeTotals = {10: 0, 11: 0, 12: 0};  // Holds the total sum of grades
    const gradeCounts = {10: 0, 11: 0, 12: 0};  // Holds the count of valid grades
    const rows = $('#editableTable tbody tr');

    // Loop through each row and collect the grade data
    rows.each(function() {
        $(this).find('.grade-cell').each(function() {
            const gradeLevel = $(this).data('grade');
            const gradeValue = parseFloat($(this).text());

            if (!isNaN(gradeValue)) {
                gradeTotals[gradeLevel] += gradeValue;  // Add valid grades to the total
                gradeCounts[gradeLevel] += 1;           // Increment the count of valid grades
            }
        });
    });

    // Update the average for each grade level
    for (let gradeLevel in gradeTotals) {
        const total = gradeTotals[gradeLevel];
        const count = gradeCounts[gradeLevel];
        const average = count > 0 ? (total / count).toFixed(2) : '0.00';

        // Update the footer cell with the calculated average
        $(`#editableTable tfoot td:eq(${gradeLevel - 10 + 1})`).text(average);  // Properly target the footer cell
    }
}

// Attach the input event listener to dynamically calculate the averages
$(document).on('input', '.grade-cell', function() {
    calculateAverage();
});

// Function to submit the editable table data
$('#submitForm').click(function() {
    const tableData = [];

    // Get all the rows in the table
    const rows = $('#editableTable tbody tr');

    // Loop through each row and collect the data
    rows.each(function() {
        const rowData = {
            subject: $(this).find('.subject-cell').text(),
            grade_10: $(this).find('.grade-cell[data-grade="10"]').text(),
            grade_11: $(this).find('.grade-cell[data-grade="11"]').text(),
            grade_12: $(this).find('.grade-cell[data-grade="12"]').text()
        };

        tableData.push(rowData);
    });

    // Collect additional form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('student', studentProfile);
    formData.append('institution', institution);
    formData.append('graduation_year', graduation_year);
    formData.append('requested_date', requested_date);
    formData.append('grade_10_average', grade_10_average);
    formData.append('grade_11_average', grade_11_average);
    formData.append('grade_12_average', grade_12_average);
    formData.append('grade_10_conduct', grade_10_conduct);
    formData.append('grade_11_conduct', grade_11_conduct);
    formData.append('grade_12_conduct', grade_12_conduct);
    formData.append('registrar_signed', registrar_signed);
    formData.append('principal_approved', principal_approved);
    formData.append('table_data', JSON.stringify(tableData));

    // Send the data to the server using AJAX
    $.ajax({
        url: '/schooladmin/create_transcript',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('Transcript saved successfully!');
        },
        error: function(xhr, status, error) {
            console.error('Error saving transcript:', error);
        }
    });
});
</script>
{% endblock custom_script %}
